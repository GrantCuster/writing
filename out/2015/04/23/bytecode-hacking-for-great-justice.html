<!DOCTYPE html><html><head><link rel="preload" href="/static/fonts/Inter-Regular.woff2?v=3.5" as="font" type="font/woff2" crossorigin="*"/><link rel="preload" href="/static/fonts/Inter-Italic.woff2?v=3.5" as="font" type="font/woff2" crossorigin="*"/><link href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" rel="stylesheet"/><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" class="next-head"/><meta charSet="utf-8" class="next-head"/><style class="next-head">.js-no-flash { display: none }</style><noscript class="jsx-4059783939 jsx-3344216300 next-head"><style>.js-no-flash { display: block }</style></noscript><link rel="icon" type="image/x-icon" href="static/images/favicon.png" class="jsx-1135431938 jsx-2959859206 next-head"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous" class="jsx-1135431938 jsx-2959859206 next-head"/><title class="jsx-1135431938 jsx-2959859206 next-head">Bytecode Hacking for Great Justice - Cloudera Fast Forward</title><link rel="preload" href="/_next/static/EnU~FBvqy_55fWO5RkIyH/pages/posts/2015-04-23-bytecode-hacking-for-great-justice.js" as="script"/><link rel="preload" href="/_next/static/EnU~FBvqy_55fWO5RkIyH/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-fdce77a122c11e06ae50.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.f77b50de979bfbbb280b.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-5ab107747766f1b4e0bf.js" as="script"/><style id="__jsx-4059783939">@font-face{font-family:'Inter';font-style:normal;font-weight:400;src:url('/static/fonts/Inter-Regular.woff2?v=3.5') format('woff2'), url('/static/fonts/Inter-Regular.woff?v=3.5') format('woff');}@font-face{font-family:'Inter';font-style:italic;font-weight:400;src:url('/static/fonts/Inter-Italic.woff2?v=3.5') format('woff2'), url('/static/fonts/Inter-Italic.woff?v=3.5') format('woff');}@font-face{font-family:'Inter';font-style:normal;font-weight:700;src:url('/static/fonts/Inter-Bold.woff2?v=3.5') format('woff2'), url('/static/fonts/Inter-Bold.woff?v=3.5') format('woff');}@font-face{font-family:'Inter';font-style:italic;font-weight:700;src:url('/static/fonts/Inter-BoldItalic.woff2?v=3.5') format('woff2'), url('/static/fonts/Inter-BoldItalic.woff?v=3.5') format('woff');}*{box-sizing:border-box;}html{font-family:'Inter',serif;font-size:18px;line-height:27px;text-rendering:optimizelegibility;font-feature-settings:'kern';font-kerning:normal;font-feature-settings:'ss02' 1;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}pre{-webkit-font-smoothing:auto;-moz-osx-font-smoothing:auto;overflow-x:auto;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo, Monaco,Courier New,monospace;}body{margin:0;overflow-x:hidden;}a{color:inherit;-webkit-text-decoration:none;text-decoration:none;-webkit-transition:opacity 0.025s linear;transition:opacity 0.025s linear;}a:hover{opacity:0.75;}a.no-hover:hover{opacity:1;}.hover_box_overlay{opacity:0;-webkit-transition:opacity 0.025s linear;transition:opacity 0.025s linear;}.hover_box:hover .hover_box_overlay{opacity:1;}a.gray-backer{-webkit-transition:background 0.05s linear;transition:background 0.05s linear;}a.gray-backer:hover{background:#f3f3f3;}button:focus{outline:#999 auto 3px;}</style><style id="__jsx-3344216300">html{font-size:17.189999999999998px;line-height:25.784999999999997px;}a,.display-link{background-image:linear-gradient( to right, black 100%, transparent 0% );background-position:0em calc(1.07em);background-repeat:repeat-x;background-size:1em 0.07em;}a.no-underline{background-image:none;}a.no-hover{background-image:none;}a.no-hover:hover{background-image:none;opacity:1;}</style><style id="__jsx-2959859206">h1,h2,h3,h4,h5,h6{font-weight:400;font-style:normal;margin:0;}h1{font-size:51.56999999999999px;line-height:1.25;}h2{font-size:34.379999999999995px;line-height:1.25;padding-top:25.784999999999997px;margin-bottom:25.784999999999997px;}h3{font-size:25.784999999999997px;line-height:1.25;padding-top:25.784999999999997px;margin-bottom:25.784999999999997px;}h4{font-size:21.487499999999997px;line-height:1.25;padding-top:0px;margin-bottom:25.784999999999997px;}h5{font-size:12.892499999999998px;line-height:1.4375;margin-bottom:12.892499999999998px;padding-bottom:12.892499999999998px;margin-top:-12.892499999999998px;}p{margin:0 0 25.784999999999997px 0;}ol,ul{margin:0 0 25.784999999999997px 0;padding-left:25.784999999999997px;}blockquote{margin:0 0 25.784999999999997px 25.784999999999997px;}.html-video-holder{margin:0 0 25.784999999999997px 0;}video{max-width:100%;}code{background:#eaeaea;padding-right:3px;padding-left:3px;font-size:0.975em;word-break:break-word;}</style><style id="__jsx-1135431938">code[class*='language-'],pre[class*='language-']{color:black;background:none;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono', monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;}pre[class*='language-']::-moz-selection,pre[class*='language-']::-moz-selection,code[class*='language-']::-moz-selection,code[class*='language-']::-moz-selection{text-shadow:none;}pre[class*='language-']::selection,pre[class*='language-']::selection,code[class*='language-']::selection,code[class*='language-']::selection{text-shadow:none;}@media print{code[class*='language-'],pre[class*='language-']{text-shadow:none;}}:not(pre)>code[class*='language-']{white-space:normal;}.token.comment,.token.prolog,.token.doctype,.token.cdata{color:slategray;}.token.punctuation{color:#999;}.namespace{opacity:0.7;}.token.property,.token.tag,.token.boolean,.token.number,.token.constant,.token.symbol,.token.deleted{color:#905;}.token.selector,.token.attr-name,.token.string,.token.char,.token.builtin,.token.inserted{color:#690;}.token.operator,.token.entity,.token.url,.language-css .token.string,.style .token.string{color:#9a6e3a;}.token.atrule,.token.attr-value,.token.keyword{color:#07a;}.token.function,.token.class-name{color:#dd4a68;}.token.regex,.token.important,.token.variable{color:#e90;}.token.important,.token.bold{font-weight:bold;}.token.italic{font-style:italic;}.token.entity{cursor:help;}</style></head><body><div id="__next"><div class="jsx-4059783939 jsx-3344216300 js-no-flash"><div style="padding-bottom:12.892499999999998px"><div style="position:relative"><div style="position:relative;padding:6.446249999999999px 12.892499999999998px 6.446249999999999px 12.892499999999998px;background-image:url(&quot;/static/images/dataline.png&quot;)"><div style="display:flex;justify-content:space-between"><div style="display:flex;align-items:center;height:25.784999999999997px;padding-top:1px"><a href="https://www.cloudera.com/products/fast-forward-labs-research.html" style="display:block;line-height:0" class="no-underline no-hover"><img style="height:12.892499999999998px" src="/static/images/cloudera.png"/></a></div><div style="display:flex;align-items:center;padding-top:1px;font-size:17.189999999999998px;line-height:1.5"><a class="no-underline" href="https://www.cloudera.com/products/fast-forward-labs-research.html" style="color:#333e47;font-size:12.892499999999998px;line-height:1.5">About Us →</a></div></div><div style="position:absolute;left:0;width:100%;height:2px;transform:scaleY(0.60165);transform-origin:center center;background:rgba(0,0,0,0.125);bottom:-1px"></div></div><div style="padding:12.892499999999998px 12.892499999999998px 12.892499999999998px 12.892499999999998px;display:flex;justify-content:space-between;font-size:17.189999999999998px;line-height:1.5"><div style="display:flex;align-items:center"><a class="no-hover no-underline" style="display:flex;align-items:center" href="/"><img style="height:18.75272727272727px;width:18.75272727272727px;margin-right:9.669374999999999px;position:relative;top:-0.5860227272727272px" src="/static/images/ff.png"/><div>Fast Forward Labs </div></a></div><div style="display:flex;align-items:center;height:25.784999999999997px"></div><div style="display:flex"><div style="margin-right:12.892499999999998px"><a href="/">Blog</a></div><div><a href="https://experiments.fastforwardlabs.com">AI Experiments</a></div></div></div><div style="position:absolute;left:0;width:100%;height:2px;transform:scaleY(0.60165);transform-origin:center center;background:black;bottom:-1px"></div></div></div><div class="jsx-1135431938 jsx-2959859206"><div style="position:relative" class="jsx-1135431938 jsx-2959859206"><div style="padding-left:6.446249999999999px;padding-right:6.446249999999999px;padding-top:25.784999999999997px" class="jsx-1135431938 jsx-2959859206"><div class="jsx-1135431938 jsx-2959859206"><div style="display:flex;margin-bottom:12.892499999999998px;width:587.1075px;margin-left:0" class="jsx-1135431938 jsx-2959859206"><div style="width:293.55375px;padding:0px 12.892499999999998px;position:relative;font-size:12.892499999999998px;letter-spacing:0.03em;text-transform:uppercase;line-height:1" class="jsx-1135431938 jsx-2959859206">Apr 05 2015</div><div style="width:293.55375px;padding:0px 12.892499999999998px;position:relative;font-size:12.892499999999998px;letter-spacing:0.03em;text-transform:uppercase;line-height:1" class="jsx-1135431938 jsx-2959859206">post</div></div><div style="margin-bottom:0" class="jsx-1135431938 jsx-2959859206"><div style="font-size:42.974999999999994px;line-height:1.25;padding:0px 12.892499999999998px;width:587.1075px;margin-left:0" class="jsx-1135431938 jsx-2959859206">Bytecode Hacking for Great Justice</div></div><div style="display:flex;flex-wrap:wrap;width:587.1075px;margin-left:0" class="jsx-1135431938 jsx-2959859206"><div style="padding:12.892499999999998px 12.892499999999998px 0px 12.892499999999998px;width:587.1075px" class="jsx-1135431938 jsx-2959859206"><div class="jsx-1135431938 jsx-2959859206">by<!-- --> <a href="http://github.com/mynameisfiber" class="jsx-1135431938 jsx-2959859206">Micha</a></div></div><div style="width:587.1075px;padding:25.784999999999997px 12.892499999999998px 25.784999999999997px 12.892499999999998px" class="jsx-1135431938 jsx-2959859206"><p><p><em>DO NOT TRY THIS AT HOME! NO PYTHONS WERE HURT IN THE CREATION OF THIS BLOG POST!</em></p></p><p><p>Check out the code at code at <a href="http://github.com/mynameisfiber/pytailcall">github.com/mynameisfiber/pytailcall</a></p></p><p><p>As an exercise into learning more about python 2.7 bytecode, I wanted to implement the thing that pythonistas <a href="http://neopythonic.blogspot.com/2009/04/tail-recursion-elimination.html">love to hate</a> - tail call optimization! This isn<!-- -->’<!-- -->t <a href="http://www.teamrubber.com/blog/python-tail-optimisation-using-byteplay/">novel</a> at all, but I chose to implement this only using the standard library so that I could understand more about generating and modifying bytecode. As a result, I<!-- -->’<!-- -->m sure there are <em>many</em> edge cases that I don<!-- -->’<!-- -->t consider so please, keep your sys-ops sane and <em>do not use this code in production</em>. <a href="https://github.com/mynameisfiber/pytailcall/">In the end</a>, even though the code is fun it is a filthy hack that shouldn<!-- -->’<!-- -->t be used in production code and should never be considered to make it<!-- -->’<!-- -->s way into the python source. One point I really like on <a href="http://neopythonic.blogspot.com/2009/04/tail-recursion-elimination.html">Guido<!-- -->’<!-- -->s blog post</a> about this issue is tail recursion optimization ruins the stack traces and detracts from python<!-- -->’<!-- -->s ability to debug easily.</p></p><p><p>Tail calls are when a function is recursing and returns simply on a function call to itself. This is different than normal recursion where multiple things can be happening on our recursed return statement. So, for example, this is tail recursion,</p></p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function">factorial</span><span class="token punctuation">(</span><span class="token plain">N</span><span class="token punctuation">,</span><span class="token plain"> result</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> N </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> result</span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> factorial</span><span class="token punctuation">(</span><span class="token plain">N</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> N</span><span class="token operator">*</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>While this is not,</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function">factorial</span><span class="token punctuation">(</span><span class="token plain">N</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> N </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> N </span><span class="token operator">*</span><span class="token plain"> factorial</span><span class="token punctuation">(</span><span class="token plain">N</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p><p>So we can see that normal recursion uses the return register in order to maintain the state of the calculation. By contrast, tail recursion uses a function parameter. This is made particularly simple in python because you can have keyword arguments with default values to initialize the calculation.</p></p><p><p>The thing that makes tail calls particularly useful is the ability to optimize them. Generally when a function gets called, the system must set up a function stack in memory that maintains the state of the function, including local variables and code pointers, so that the function can go on its merry way. However, when we do a tail recursion we are trying to enter the same function stack that we are already in, just with changes to the values of the arguments! This can be quickly optimized by never creating the new function stack and instead just modifying the argument values and starting the function from the beginning!</p></p><p><p>One way of doing this is manually unravelling the recursion. For our example above, the factorial would become,</p></p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function">factorial</span><span class="token punctuation">(</span><span class="token plain">N</span><span class="token punctuation">,</span><span class="token plain"> result</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> N </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">            </span><span class="token keyword">return</span><span class="token plain"> result</span></span></div><div class="token-line"><span><span class="token plain">        N</span><span class="token punctuation">,</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> N</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> N</span><span class="token operator">*</span><span class="token plain">result</span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p><p>Not only will this speed up our code, but we also don<!-- -->’<!-- -->t have to worry about those pesky <a href="https://docs.python.org/2/library/sys.html#sys.setrecursionlimit">recursion limits</a> that python imposes on us. Furthermore, the transformation is quite simple. All we did was add a <code>while True:</code> to the beginning of the function and change any tail calls with changes to the argument variables.</p></p><p><p>There are a whole host of methods to do this automatically (<a href="http://tomforb.es/adding-tail-call-optimization-to-python">partial functions</a>, <a href="http://lambda-the-ultimate.org/node/1331">exceptions</a>, etc., but I thought it would be fun to do this by re-writing the bytecode of the function itself. Let<!-- -->’<!-- -->s start by looking at the actual bytecode of the <code>factorial</code> function using the <code>dis</code> module from the standard library.</p></p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token plain">&gt;&gt;&gt; dis.dis(factorial)</span></span></div><div class="token-line"><span><span class="token plain"># bytecode                                             # relevant python</span></span></div><div class="token-line"><span><span class="token plain"># -----------------------------------------------------#---------------------</span></span></div><div class="token-line"><span><span class="token plain">  2           0 LOAD_FAST                0 (N)         # if N == 1:</span></span></div><div class="token-line"><span><span class="token plain">              3 LOAD_CONST               1 (1)         #</span></span></div><div class="token-line"><span><span class="token plain">              6 COMPARE_OP               2 (==)        #</span></span></div><div class="token-line"><span><span class="token plain">              9 POP_JUMP_IF_FALSE       16             #</span></span></div><div class="token-line"><span><span class="token plain">                                                       #</span></span></div><div class="token-line"><span><span class="token plain">  3          12 LOAD_FAST               1 (result)     #    return result</span></span></div><div class="token-line"><span><span class="token plain">             15 RETURN_VALUE                           #</span></span></div><div class="token-line"><span><span class="token plain">                                                       #</span></span></div><div class="token-line"><span><span class="token plain">  4     &gt;&gt;   16 LOAD_GLOBAL              0 (factorial) # return factorial(N-1, N*result)</span></span></div><div class="token-line"><span><span class="token plain">             19 LOAD_FAST                0 (N)         #</span></span></div><div class="token-line"><span><span class="token plain">             22 LOAD_CONST               1 (1)         #</span></span></div><div class="token-line"><span><span class="token plain">             25 BINARY_SUBTRACT                        #</span></span></div><div class="token-line"><span><span class="token plain">             26 LOAD_FAST                0 (N)         #</span></span></div><div class="token-line"><span><span class="token plain">             29 LOAD_FAST                1 (result)    #</span></span></div><div class="token-line"><span><span class="token plain">             32 BINARY_MULTIPLY                        #</span></span></div><div class="token-line"><span><span class="token plain">             33 CALL_FUNCTION            2             #</span></span></div><div class="token-line"><span><span class="token plain">             36 RETURN_VALUE                           #</span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p><p>We can see the full structure of our function in the bytecode. First we load up <code>N</code> and the constant <code>1</code> and compare them using the <code>COMPARE_OP</code> bytecode. If the result if false, we jump to line 16 and if not we load the variable <code>result</code> into the stack and return it. On line 16, we first load the reference to the function named <code>factorial</code> (which happens to be the same function we<!-- -->’<!-- -->re in!) and start building up the arguments. First we load up <code>N</code> and <code>1</code> and call <code>BINARY_SUBTRACT</code> which will leave the value of <code>N-1</code> on the stack. Then we load up <code>N</code> and <code>result</code> and multiply them with <code>BINARY_MULTIPLY</code> which will push the value of <code>N-1</code> onto the stack. By calling the <code>CALL_FUNCTION</code> bytecode (with the argument <code>2</code> indicating that there are two arguments to the function), python can go out and start running the function in another context until it returns and we can call <code>RETURN_VALUE</code> on line 36 to return whatever is left in the stack. This may seem like a convoluted way of approaching how a function works (although it <a href="http://shop.oreilly.com/product/0636920028963.do">has its uses</a>!), but after a while spent looking at <a href="http://unpyc.sourceforge.net/Opcodes.html">opcodes</a> this starts to make just as much sense as python itself!</p></p><p><p>In an ideal world, what would we want this bytecode to look like? Looking up the references on <code>JUMP_ABSOLUTE</code>, we can rewrite the above bytecode to be,</p></p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token plain">  2     &gt;&gt;    0 LOAD_FAST                0 (N)</span></span></div><div class="token-line"><span><span class="token plain">              3 LOAD_CONST               1 (1)</span></span></div><div class="token-line"><span><span class="token plain">              6 COMPARE_OP               2 (==)</span></span></div><div class="token-line"><span><span class="token plain">              9 POP_JUMP_IF_FALSE       16</span></span></div><div class="token-line"><span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">  3          12 LOAD_FAST               1 (result)</span></span></div><div class="token-line"><span><span class="token plain">             15 RETURN_VALUE</span></span></div><div class="token-line"><span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">  4     &gt;&gt;   16 LOAD_FAST                0 (N)</span></span></div><div class="token-line"><span><span class="token plain">             19 LOAD_CONST               1 (1)</span></span></div><div class="token-line"><span><span class="token plain">             22 BINARY_SUBTRACT</span></span></div><div class="token-line"><span><span class="token plain">             23 LOAD_FAST                0 (N)</span></span></div><div class="token-line"><span><span class="token plain">             26 LOAD_FAST                1 (result)</span></span></div><div class="token-line"><span><span class="token plain">             29 BINARY_MULTIPLY</span></span></div><div class="token-line"><span><span class="token plain">             30 STORE_FAST               1 (result)</span></span></div><div class="token-line"><span><span class="token plain">             33 STORE_FAST               0 (N)</span></span></div><div class="token-line"><span><span class="token plain">             36 JUMP_ABSOLUTE            0</span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p><p>The differences here start at line 16. Instead of loading a reference to the recursed function, we immediately start filling up the stack with what <em>were</em> the arguments to the function. Then, once our arguments have been computed, instead of doing a <code>CALL_FUNCTION</code>, we start running a sequence of <code>STORE_FAST</code> to pop the calculated arguments off the stack and into the actual argument variables. Now that the arguments have been modified, we can call <code>JUMP_ABSOLUTE</code> with an argument of <code>0</code> in order to jump back to the beginning of the function and starting again. This last aspect, the <code>JUMP_ABSOLUTE</code> back to the beginning of the function as oppose to setting up a while loop, is one of the reasons this function is faster than the manual unrolling of the recursion we did above; we don<!-- -->’<!-- -->t need to calculate the conditions of the loop or do any modifications to our state, we simply start processing opcodes at line 0 again.</p></p><p><p>This may seem simple, but there are many corner cases that will get you (and in fact got me in the hours of <code>SystemError</code> exceptions I wrestled with). First of all, if the recursive return is already within what python calls a block (ie: a loop or a try..except..finally block), we need to call the <code>POP_BLOCK</code> opcode the right amount of times before our <code>JUMP_ABSOLUTE</code> so that we properly terminate any setup those sections need.</p>
<p>Another problem, and probably much more annoying than the block counts, is that of changing the size and thus the addresses of the bytecodes. When bytecode is represented, it is simply a list of unsigned four-bit integers. Some of these integers represent jumps to other points in the list, and it refers to those other points by either relative offsets (e.g., jump five integers to the right) or by absolute addresses (e.g., jump to the tenth integer). In order to make sure these jumps go to the correct place after we modify the bytecode, we must keep a list of what we added (and where) and, once our editing is done, go back through and modify any addresses to again point to the correct place.</p></p><p><p>Once all these problems are solved, we are left with a <a href="https://github.com/mynameisfiber/pytailcall/blob/master/pytailcall/internal_loop.py#L77">general decorator</a> to transform all of our tail recursion into the iterative versions! And this is indeed much faster. Looking at the benchmark supplied with <a href="https://github.com/mynameisfiber/pytailcall/">pytailcall</a>, we can see that we reduce the overhead of recursion (by eliminating it) and are able to recurse much more than we were previously able to.</p></p><p><a href="http://i.imgur.com/OodCK0c.png"><div style="position:relative"><img src="http://i.imgur.com/OodCK0c.png" alt="pytailcall benchmarks" style="display:block;margin:0;width:100%"/></div></a></p><p><p>In the <a href="https://github.com/mynameisfiber/pytailcall/blob/master/pytailcall/examples.py">benchmark</a> above, <code>native</code> is the original function (note that native python could not complete all of the benchmarks due to maximum recursion errors). <code>partial_func</code> is a trick which wraps the function in a partial and changes it<!-- -->’<!-- -->s internal reference to itself. <code>return_tuple</code> is another bytecode hack that changes the recursion into a specialized return statement that triggers another call to the function. Finally, <code>internal_loop</code> is the bytecode hack described above.</p></p><p><p>So, by committing this ungodly sin against all things python stands for, we can get a 33% speedup over python tail recursed code! In general though, this was a great exercise in learning much more about how python bytecode works and the underlying structure of a function. While this sort of bytecode hacking is exactly that, a hack, being able to read bytecode and understand the output of <code>dis.dis</code> is incredibly useful when optimizing python code for actual production systems. If you want to know more about <em>that</em> aspect of the optimization, and other more rigorous methods of optimization, check out <a href="http://shop.oreilly.com/product/0636920028963.do">High Performance Python</a>.</p></p><p><p>-Micha</p></p><div style="display:none;justify-content:center;padding:12.892499999999998px" class="jsx-1135431938 jsx-2959859206"><img style="height:18.75272727272727px;width:18.75272727272727px;position:relative;display:block" src="/static/images/ff.png" class="jsx-1135431938 jsx-2959859206"/></div></div></div></div><div style="position:relative;display:block;width:612.8924999999999px;grid-template-columns:repeat(2, 1fr);margin-left:-12.892499999999998px;margin-right:-12.892499999999998px"><div style="display:grid"><div style="position:relative;display:grid;grid-template-rows:auto 1fr;margin-bottom:12.892499999999998px"><div style="text-transform:uppercase;font-size:12.892499999999998px;letter-spacing:0.03em;line-height:1.5;padding-bottom:6.446249999999999px;padding-left:25.784999999999997px">Newer</div><div style="position:relative;display:grid"><a class="hover-box no-underline no-hover gray-backer hover-extend" style="display:block;position:relative;width:612.8925px;padding-left:12.892499999999998px;padding-right:12.892499999999998px;margin-left:0;margin-right:0" href="/2015/04/30/our-fearless-leader-hilary-mason-appeared.html"><div style="display:flex;flex-wrap:wrap"><div style="display:flex;width:587.1075px;font-size:12.892499999999998px;letter-spacing:0.03em;text-transform:uppercase;line-height:1.5;margin-left:0"><div style="width:293.55375px;padding:12.892499999999998px 12.892499999999998px 0px 12.892499999999998px"><div>Apr 05 2015</div></div><div style="width:293.55375px;padding:12.892499999999998px 12.892499999999998px 0px 12.892499999999998px"><div>Announcement</div></div></div><div style="position:relative;width:587.1075px;padding:12.892499999999998px 0px"><div style="font-size:25.784999999999997px;line-height:1.25;padding:0px 12.892499999999998px;margin-top:-6.446249999999999px"><div style="padding-left:0">Hilary on Bloomberg TV</div></div><div style="padding-top:6.446249999999999px;position:relative"><div style="font-size:15.041249999999998px;line-height:1.5em;display:flex;flex-wrap:wrap;padding-left:0"><div style="padding:0px 12.892499999999998px;width:293.55375px"><div style="height:90.24749999999999px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:4;hyphens:auto;-webkit-box-orient:vertical">

Our fearless leader Hilary Mason appeared yesterday on Bloomberg TV to discuss Selerity’s early acquisition of Twitter’s earnings data.  The interview video is available here.
</div><div style="overflow:hidden;width:100%;text-overflow:ellipsis;white-space:nowrap"><span class="display-link"><span>View<!-- --> <span style="text-transform:lowercase">Announcement</span></span></span></div></div><div style="position:relative;width:293.55375px"><div style="width:calc(100% - 25.784999999999997px);height:calc(100% - 12.892499999999998px);margin-left:12.892499999999998px;margin-top:6.446249999999999px;background-image:url(/static/tumblr_files/tumblr_nnn20a7yAI1teyfqto1_r1_1280.png);background-size:contain;background-position:center center;background-repeat:no-repeat"></div></div></div></div></div></div></a><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><div style="display:grid"><div style="position:relative;display:grid;grid-template-rows:auto 1fr;margin-bottom:12.892499999999998px"><div style="text-transform:uppercase;font-size:12.892499999999998px;letter-spacing:0.03em;line-height:1.5;padding-bottom:6.446249999999999px;padding-left:25.784999999999997px">Older</div><div style="position:relative;display:grid"><a class="hover-box no-underline no-hover gray-backer hover-extend" style="display:block;position:relative;width:612.8925px;padding-left:12.892499999999998px;padding-right:12.892499999999998px;margin-left:0;margin-right:0" href="/2015/04/01/our-second-rd-report-probabilistic-methods-for.html"><div style="display:flex;flex-wrap:wrap"><div style="display:flex;width:587.1075px;font-size:12.892499999999998px;letter-spacing:0.03em;text-transform:uppercase;line-height:1.5;margin-left:0"><div style="width:293.55375px;padding:12.892499999999998px 12.892499999999998px 0px 12.892499999999998px"><div>Apr 04 2015</div></div><div style="width:293.55375px;padding:12.892499999999998px 12.892499999999998px 0px 12.892499999999998px"><div>announcement</div></div></div><div style="position:relative;width:587.1075px;padding:12.892499999999998px 0px"><div style="font-size:25.784999999999997px;line-height:1.25;padding:0px 12.892499999999998px;margin-top:-6.446249999999999px"><div style="padding-left:0">Probabilistic Methods for Realtime Streams</div></div><div style="padding-top:6.446249999999999px;position:relative"><div style="font-size:15.041249999999998px;line-height:1.5em;display:flex;flex-wrap:wrap;padding-left:0"><div style="padding:0px 12.892499999999998px;width:293.55375px"><div style="height:90.24749999999999px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:4;hyphens:auto;-webkit-box-orient:vertical">

Our second R&amp;D Report, Probabilistic Methods for Realtime Streams, has gone out! In this report, we explored probabilistic algorithms for machine learning on potentially large realtime streams of data with efficient CPU and memory usage.

Our prototype demonstrated these...</div><div style="overflow:hidden;width:100%;text-overflow:ellipsis;white-space:nowrap"><span class="display-link"><span>View<!-- --> <span style="text-transform:lowercase">announcement</span></span></span></div></div><div style="position:relative;width:293.55375px"><div style="width:calc(100% - 25.784999999999997px);height:calc(100% - 12.892499999999998px);margin-left:12.892499999999998px;margin-top:6.446249999999999px;background-image:url(/static/tumblr_files/tumblr_nm5a0kCyu11teyfqto1_1280.jpg);background-size:contain;background-position:center center;background-repeat:no-repeat"></div></div></div></div></div></div></a><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div></div><div style="padding-bottom:25.784999999999997px;padding-top:25.784999999999997px" class="jsx-1135431938 jsx-2959859206"><div style="font-size:34.379999999999995px;line-height:1.25;padding:0px 12.892499999999998px 0px 12.892499999999998px;margin-bottom:12.892499999999998px;width:587.1075px;margin-left:0" class="jsx-1135431938 jsx-2959859206">About</div><div style="padding:0px 12.892499999999998px;margin-bottom:12.892499999999998px;width:587.1075px;margin-left:0;font-size:17.189999999999998px;line-height:1.5" class="jsx-1135431938 jsx-2959859206">Cloudera Fast Forward Labs is an applied machine learning research group. We help organizations recognize and develop new product and business opportunities through emerging technologies.<!-- --> </div><div style="padding:0px 12.892499999999998px;margin-bottom:12.892499999999998px;width:587.1075px;margin-left:0;font-size:17.189999999999998px;line-height:1.5" class="jsx-1135431938 jsx-2959859206"><a href="https://www.cloudera.com/products/fast-forward-labs-research.html" class="jsx-1135431938 jsx-2959859206">Learn more about working with us.</a></div></div></div><div class="jsx-1135431938 jsx-2959859206"><div style="position:relative" class="jsx-1135431938 jsx-2959859206"><div style="position:absolute;left:0;width:100%;height:2px;transform:scaleY(0.60165);transform-origin:center center;background:black;top:-1px"></div><div style="padding:12.892499999999998px;display:flex;justify-content:space-between;flex-wrap:wrap;font-size:17.189999999999998px;line-height:1.5" class="jsx-1135431938 jsx-2959859206"><div class="jsx-1135431938 jsx-2959859206"><a href="/" class="jsx-1135431938 jsx-2959859206">Blog</a></div><div style="display:flex;flex-wrap:wrap" class="jsx-1135431938 jsx-2959859206"><div style="margin-right:12.892499999999998px" class="jsx-1135431938 jsx-2959859206"><a href="https://www.cloudera.com/products/fast-forward-labs-research.html" class="jsx-1135431938 jsx-2959859206">Cloudera</a></div><div style="margin-right:12.892499999999998px" class="jsx-1135431938 jsx-2959859206"><a href="https://blog.fastforwardlabs.com/" class="jsx-1135431938 jsx-2959859206">AI Experiments</a></div><div class="jsx-1135431938 jsx-2959859206"><a href="https://twitter.com/fastforwardlabs" class="jsx-1135431938 jsx-2959859206">Twitter</a></div></div></div></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/posts/2015-04-23-bytecode-hacking-for-great-justice","query":{},"buildId":"EnU~FBvqy_55fWO5RkIyH","nextExport":true}</script><script async="" id="__NEXT_PAGE__/posts/2015-04-23-bytecode-hacking-for-great-justice" src="/_next/static/EnU~FBvqy_55fWO5RkIyH/pages/posts/2015-04-23-bytecode-hacking-for-great-justice.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/EnU~FBvqy_55fWO5RkIyH/pages/_app.js"></script><script src="/_next/static/runtime/webpack-fdce77a122c11e06ae50.js" async=""></script><script src="/_next/static/chunks/commons.f77b50de979bfbbb280b.js" async=""></script><script src="/_next/static/runtime/main-5ab107747766f1b4e0bf.js" async=""></script></body></html>