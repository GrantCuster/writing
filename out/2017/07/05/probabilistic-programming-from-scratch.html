<!DOCTYPE html><html><head><link rel="preload" href="/static/fonts/Inter-Regular.woff2?v=3.5" as="font" type="font/woff2" crossorigin="*"/><link rel="preload" href="/static/fonts/Inter-Italic.woff2?v=3.5" as="font" type="font/woff2" crossorigin="*"/><link href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" rel="stylesheet"/><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" class="next-head"/><meta charSet="utf-8" class="next-head"/><style class="next-head">.js-no-flash { display: none }</style><noscript class="jsx-4059783939 jsx-3344216300 next-head"><style>.js-no-flash { display: block }</style></noscript><link rel="icon" type="image/x-icon" href="static/images/favicon.png" class="jsx-1135431938 jsx-2959859206 next-head"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous" class="jsx-1135431938 jsx-2959859206 next-head"/><title class="jsx-1135431938 jsx-2959859206 next-head">Probabilistic programming from scratch - Cloudera Fast Forward</title><link rel="preload" href="/_next/static/Ybc3fb3eGTaHFGC_lgzB6/pages/posts/2017-07-05-probabilistic-programming-from-scratch.js" as="script"/><link rel="preload" href="/_next/static/Ybc3fb3eGTaHFGC_lgzB6/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-fdce77a122c11e06ae50.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.f77b50de979bfbbb280b.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-5ab107747766f1b4e0bf.js" as="script"/><style id="__jsx-4059783939">@font-face{font-family:'Inter';font-style:normal;font-weight:400;src:url('/static/fonts/Inter-Regular.woff2?v=3.5') format('woff2'), url('/static/fonts/Inter-Regular.woff?v=3.5') format('woff');}@font-face{font-family:'Inter';font-style:italic;font-weight:400;src:url('/static/fonts/Inter-Italic.woff2?v=3.5') format('woff2'), url('/static/fonts/Inter-Italic.woff?v=3.5') format('woff');}@font-face{font-family:'Inter';font-style:normal;font-weight:700;src:url('/static/fonts/Inter-Bold.woff2?v=3.5') format('woff2'), url('/static/fonts/Inter-Bold.woff?v=3.5') format('woff');}@font-face{font-family:'Inter';font-style:italic;font-weight:700;src:url('/static/fonts/Inter-BoldItalic.woff2?v=3.5') format('woff2'), url('/static/fonts/Inter-BoldItalic.woff?v=3.5') format('woff');}*{box-sizing:border-box;}html{font-family:'Inter',serif;font-size:18px;line-height:27px;text-rendering:optimizelegibility;font-feature-settings:'kern';font-kerning:normal;font-feature-settings:'ss02' 1;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}pre{-webkit-font-smoothing:auto;-moz-osx-font-smoothing:auto;overflow-x:auto;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo, Monaco,Courier New,monospace;}body{margin:0;overflow-x:hidden;}a{color:inherit;-webkit-text-decoration:none;text-decoration:none;-webkit-transition:opacity 0.025s linear;transition:opacity 0.025s linear;}a:hover{opacity:0.75;}a.no-hover:hover{opacity:1;}.hover_box_overlay{opacity:0;-webkit-transition:opacity 0.025s linear;transition:opacity 0.025s linear;}.hover_box:hover .hover_box_overlay{opacity:1;}a.gray-backer{-webkit-transition:background 0.05s linear;transition:background 0.05s linear;}a.gray-backer:hover{background:#f3f3f3;}button:focus{outline:#999 auto 3px;}</style><style id="__jsx-3344216300">html{font-size:17.189999999999998px;line-height:25.784999999999997px;}a,.display-link{background-image:linear-gradient( to right, black 100%, transparent 0% );background-position:0em calc(1.07em);background-repeat:repeat-x;background-size:1em 0.07em;}a.no-underline{background-image:none;}a.no-hover{background-image:none;}a.no-hover:hover{background-image:none;opacity:1;}</style><style id="__jsx-2959859206">h1,h2,h3,h4,h5,h6{font-weight:400;font-style:normal;margin:0;}h1{font-size:51.56999999999999px;line-height:1.25;}h2{font-size:34.379999999999995px;line-height:1.25;padding-top:25.784999999999997px;margin-bottom:25.784999999999997px;}h3{font-size:25.784999999999997px;line-height:1.25;padding-top:25.784999999999997px;margin-bottom:25.784999999999997px;}h4{font-size:21.487499999999997px;line-height:1.25;padding-top:0px;margin-bottom:25.784999999999997px;}h5{font-size:12.892499999999998px;line-height:1.4375;margin-bottom:12.892499999999998px;padding-bottom:12.892499999999998px;margin-top:-12.892499999999998px;}p{margin:0 0 25.784999999999997px 0;}ol,ul{margin:0 0 25.784999999999997px 0;padding-left:25.784999999999997px;}blockquote{margin:0 0 25.784999999999997px 25.784999999999997px;}.html-video-holder{margin:0 0 25.784999999999997px 0;}video{max-width:100%;}code{background:#eaeaea;padding-right:3px;padding-left:3px;font-size:0.975em;word-break:break-word;}</style><style id="__jsx-1135431938">code[class*='language-'],pre[class*='language-']{color:black;background:none;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono', monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;}pre[class*='language-']::-moz-selection,pre[class*='language-']::-moz-selection,code[class*='language-']::-moz-selection,code[class*='language-']::-moz-selection{text-shadow:none;}pre[class*='language-']::selection,pre[class*='language-']::selection,code[class*='language-']::selection,code[class*='language-']::selection{text-shadow:none;}@media print{code[class*='language-'],pre[class*='language-']{text-shadow:none;}}:not(pre)>code[class*='language-']{white-space:normal;}.token.comment,.token.prolog,.token.doctype,.token.cdata{color:slategray;}.token.punctuation{color:#999;}.namespace{opacity:0.7;}.token.property,.token.tag,.token.boolean,.token.number,.token.constant,.token.symbol,.token.deleted{color:#905;}.token.selector,.token.attr-name,.token.string,.token.char,.token.builtin,.token.inserted{color:#690;}.token.operator,.token.entity,.token.url,.language-css .token.string,.style .token.string{color:#9a6e3a;}.token.atrule,.token.attr-value,.token.keyword{color:#07a;}.token.function,.token.class-name{color:#dd4a68;}.token.regex,.token.important,.token.variable{color:#e90;}.token.important,.token.bold{font-weight:bold;}.token.italic{font-style:italic;}.token.entity{cursor:help;}</style></head><body><div id="__next"><div class="jsx-4059783939 jsx-3344216300 js-no-flash"><div style="padding-bottom:12.892499999999998px"><div style="position:relative"><div style="position:relative;padding:6.446249999999999px 12.892499999999998px 6.446249999999999px 12.892499999999998px;background-image:url(&quot;/static/images/dataline.png&quot;)"><div style="display:flex;justify-content:space-between"><div style="display:flex;align-items:center;height:25.784999999999997px;padding-top:1px"><a href="https://www.cloudera.com/products/fast-forward-labs-research.html" style="display:block;line-height:0" class="no-underline no-hover"><img style="height:12.892499999999998px" src="/static/images/cloudera.png"/></a></div><div style="display:flex;align-items:center;padding-top:1px;font-size:17.189999999999998px;line-height:1.5"><a class="no-underline" href="https://www.cloudera.com/products/fast-forward-labs-research.html" style="color:#333e47;font-size:12.892499999999998px;line-height:1.5">About Us â†’</a></div></div><div style="position:absolute;left:0;width:100%;height:2px;transform:scaleY(0.60165);transform-origin:center center;background:rgba(0,0,0,0.125);bottom:-1px"></div></div><div style="padding:12.892499999999998px 12.892499999999998px 12.892499999999998px 12.892499999999998px;display:flex;justify-content:space-between;font-size:17.189999999999998px;line-height:1.5"><div style="display:flex;align-items:center"><a class="no-hover no-underline" style="display:flex;align-items:center" href="/"><img style="height:18.75272727272727px;width:18.75272727272727px;margin-right:9.669374999999999px;position:relative;top:-0.5860227272727272px" src="/static/images/ff.png"/><div>Fast Forward Labs </div></a></div><div style="display:flex;align-items:center;height:25.784999999999997px"></div><div style="display:flex"><div style="margin-right:12.892499999999998px"><a href="/">Blog</a></div><div><a href="https://experiments.fastforwardlabs.com">AI Experiments</a></div></div></div><div style="position:absolute;left:0;width:100%;height:2px;transform:scaleY(0.60165);transform-origin:center center;background:black;bottom:-1px"></div></div></div><div class="jsx-1135431938 jsx-2959859206"><div style="position:relative" class="jsx-1135431938 jsx-2959859206"><div style="padding-left:6.446249999999999px;padding-right:6.446249999999999px;padding-top:25.784999999999997px" class="jsx-1135431938 jsx-2959859206"><div class="jsx-1135431938 jsx-2959859206"><div style="display:flex;margin-bottom:12.892499999999998px;width:587.1075px;margin-left:0" class="jsx-1135431938 jsx-2959859206"><div style="width:293.55375px;padding:0px 12.892499999999998px;position:relative;font-size:12.892499999999998px;letter-spacing:0.03em;text-transform:uppercase;line-height:1" class="jsx-1135431938 jsx-2959859206">Jul 05 2017</div><div style="width:293.55375px;padding:0px 12.892499999999998px;position:relative;font-size:12.892499999999998px;letter-spacing:0.03em;text-transform:uppercase;line-height:1" class="jsx-1135431938 jsx-2959859206">post</div></div><div style="margin-bottom:0" class="jsx-1135431938 jsx-2959859206"><div style="font-size:42.974999999999994px;line-height:1.25;padding:0px 12.892499999999998px;width:587.1075px;margin-left:0" class="jsx-1135431938 jsx-2959859206">Probabilistic programming from scratch</div></div><div style="display:flex;flex-wrap:wrap;width:587.1075px;margin-left:0" class="jsx-1135431938 jsx-2959859206"><div style="padding:12.892499999999998px 12.892499999999998px 0px 12.892499999999998px;width:587.1075px" class="jsx-1135431938 jsx-2959859206"><div class="jsx-1135431938 jsx-2959859206">by<!-- --> <a href="https://twitter.com/mikepqr" class="jsx-1135431938 jsx-2959859206">Mike</a></div></div><div style="width:587.1075px;padding:25.784999999999997px 12.892499999999998px 25.784999999999997px 12.892499999999998px" class="jsx-1135431938 jsx-2959859206"><h5>This article contains highlights from a series of <a href="https://www.safaribooksonline.com/search/?query=%22Probabilistic%20Programming%20from%20Scratch%22&amp;extended_publisher_data=true&amp;highlight=true&amp;is_academic_institution_account=false&amp;source=user&amp;include_assessments=false&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;publishers=O%27Reilly%20Media%2C%20Inc.&amp;field=title&amp;sort=relevance&amp;utm_source=oreilly&amp;utm_medium=newsite&amp;utm_campaign=probabilistic-programming-from-scratch-top-cta-orioles-link">three interactive video tutorials</a> on probabilistic programming from scratch published on O&#x27;Reilly Safari (login required).</h5><h5>If you&#x27;re interested in the business case for probabilistic programming the <a href="http://blog.fastforwardlabs.com/2017/01/18/new-research-on-probabilistic-programming.html">Fast Forward Labs report</a> discusses it in detail, and compares modern industrial strength systems like Stan and PyMC3. Please <a href="http://www.fastforwardlabs.com/#contact">get in touch</a> if you&#x27;re interested in working with us.</h5><h5>This article is <a href="https://github.com/fastforwardlabs/probabilistic-programming-from-scratch">available as a Jupyter Notebook</a>.</h5><p>Real-world data is almost always incomplete or inaccurate in some way. This means that the uncertain conclusions we draw from it are only meaningful if we can answer the question: how uncertain?</p><p>One way to do this is using Bayesian inference. But, while Bayesian inference is conceptually simple, it can be analytically and computationally difficult in practice. Probabilistic programming is a paradigm that abstracts away some of this complexity.</p><p>There are many probabilistic programming systems. Perhaps the most advanced is <a href="http://mc-stan.org/">Stan</a>, and the most accessible to non-statistician programmers is <a href="https://pymc-devs.github.io/pymc3/">PyMC3</a>. At Fast Forward Labs we recently shared with our clients a <a href="http://blog.fastforwardlabs.com/2017/01/18/new-research-on-probabilistic-programming.html">detailed report on the technology and uses of probabilistic programming in startups and enterprises</a>.</p><p>But in this article, rather than use either of these advanced comprehensive systems, we&#x27;re going to build our own extremely simple system from scratch.</p><p>We&#x27;ll write clear, functional Python 3. We&#x27;ll use generators to build up a pipeline that will allow us to answer concrete questions. We won&#x27;t use any libraries (except for random number generation and plotting). And I&#x27;ll go easy on the mathematics. The code will be slow compared to Stan and PyMC3, but hopefully you&#x27;ll understand every line.</p><p>This &quot;from scratch&quot; approach follows in the footsteps of Joel Grus&#x27;s book <a href="http://shop.oreilly.com/product/0636920033400.do">Data Science from Scratch</a>, and Jake
VanderPlas&#x27;s PyCon talk <a href="https://www.youtube.com/watch?v=Iq9DzN6mvYA">Statistics for Hackers</a>. I recommend both! In his talk, Jake said, &quot;if you can write a for loop, you can do statistical analysis&quot;. That isn&#x27;t always true (good luck implementing <a href="https://arxiv.org/abs/1603.00788">ADVI</a> with a for loop). But when it is true, we can focus on the big, fundamental ideas without getting lost in algebraic or computational details.</p><h2>An A/B test</h2><p>Let&#x27;s take a specific data analysis problem: a simple A/B test for a website. Suppose our site has two layouts. During our test, 4% of visitors to layout A convert (i.e., buy something, sign up for the mailing list, whatever), and 5% to layout B convert. Clearly, layout B is better, so we should use that layout, right?</p><p>But what if I tell you it was a very small test?</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token plain">n_visitors_a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">100</span><span class="token plain">  </span><span class="token comment"># number of visitors shown layout A</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">n_conv_a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain">        </span><span class="token comment"># number of vistors shown layout A who converted</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">n_visitors_b </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">40</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">n_conv_b </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>Are you still sure B is better? And what if it&#x27;s going to cost us $1 million to change the layout if we get this decsion wrong. Are you sure enough? If not, how much more data would you need?</p><p>To answer these questions, we need to quantify exactly how confident we are that layout B is better, given the slice of data we do have.</p><h2>A simple algorithm for Bayesian inference</h2><p>We can do that using Bayesian inference. Bayesian inference is a method for updating your knowledge about the world with the information you learn during an experiment. It derives from a simple equation called Bayes&#x27;s Rule. In its most advanced and efficient forms, it can be used to solve huge problems. But we&#x27;re going use a specific, simple inference algorithm called Approximate Bayesian Computation (ABC), which is barely a couple of lines of Python:</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function">posterior_sampler</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">,</span><span class="token plain"> prior_sampler</span><span class="token punctuation">,</span><span class="token plain"> simulate</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token triple-quoted-string">&#x27;&#x27;&#x27;Yield samples from the posterior by Approximate Bayesian Computation.&#x27;&#x27;&#x27;</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token keyword">for</span><span class="token plain"> p </span><span class="token keyword">in</span><span class="token plain"> prior_sampler</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> simulate</span><span class="token punctuation">(</span><span class="token plain">p</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> data</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">            </span><span class="token keyword">yield</span><span class="token plain"> p</span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>This function turns the <em>prior</em> distribution into the <em>posterior</em>. What does that mean?</p><p>I talk about these distributions in more detail in <a href="https://www.safaribooksonline.com/search/?query=%22Probabilistic%20Programming%20from%20Scratch%22&amp;extended_publisher_data=true&amp;highlight=true&amp;is_academic_institution_account=false&amp;source=user&amp;include_assessments=false&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;publishers=O%27Reilly%20Media%2C%20Inc.&amp;field=title&amp;sort=relevance&amp;utm_source=oreilly&amp;utm_medium=newsite&amp;utm_campaign=probabilistic-programming-from-scratch-top-cta-orioles-link">the video tutorials</a>, but for this article, the rough idea is sufficient: samples from the prior distribution are our best guesses of the values of the unknown parameter of our system. In the case of an A/B test, this is the conversion fraction of a layout. These guesses are made before we do the experiment.</p><p>Samples from the posterior distribution, meanwhile, are guesses of the same parameters made <em>after</em> the experiment, in the light of the data we gathered. Once you have the posterior, you can answer concrete questions about the implications of the data, such as how likely it is that layout B is better, given our data.</p><p>In the function above, the <code>prior_sampler</code> argument is a generator that yields samples from the prior. We run the function <code>simulate</code> on a single sample from the prior. This <em>simulates</em> the experiment, <em>assuming</em> the prior sample is correct. We then compare the simulated outcome to the real outcome (<code>data</code>). If these agree, the sample from the prior can be used as a sample from the posterior. If not, we try again with another sample from the prior, until they do agree.</p><p>After we run a lot of simulations using lots of samples from the prior, we&#x27;ll have a good idea of which values were most likely to produce the observations we in fact saw, and are therefore most likely to be correct.</p><h2>Using the sampler</h2><p>And that&#x27;s the whole algorithm. Abstracted away in that little <code>posterior_sampler</code> generator function, it&#x27;s an extremely lightweight probabilistic programming system.</p><p>Let&#x27;s use it to finish our A/B test, starting with layout A. We need to prepare three arguments: <code>data</code>, <code>prior_sampler</code> and <code>simulate</code>. We already have the <code>data</code> for our A/B test. Let&#x27;s now write a function that simulates the conversion of <code>n_visitors</code> visitors to a website with known probability <code>p</code>:</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token keyword">import</span><span class="token plain"> random</span></span></div><div class="token-line"><span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function">simulate_conversion</span><span class="token punctuation">(</span><span class="token plain">p</span><span class="token punctuation">,</span><span class="token plain"> n_visitors</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token triple-quoted-string">&#x27;&#x27;&#x27;Return number of vistors who convert, given conversion fraction p.&#x27;&#x27;&#x27;</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    outcomes </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">random</span><span class="token punctuation">.</span><span class="token plain">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> p </span><span class="token keyword">for</span><span class="token plain"> i </span><span class="token keyword">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token plain">n_visitors</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token plain">outcomes</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>Here&#x27;s what happens when we run this function a few times to simulate 100 visitors converting with probability 0.1:</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> simulate_conversion</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> simulate_conversion</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> simulate_conversion</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">11</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">12</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>Effectively, this function runs a fake A/B test in which we already know the conversion fraction. Here&#x27;s how it works. The <code>random</code> function returns a random floating point number between 0 and 1. That number will be smaller than <code>p</code> with probability equal to <code>p</code>. We use a generator expression to do this <code>n_visitors</code> times. <code>outcomes</code> is then an iterable of booleans, <code>True</code> if that trial was a success (i.e. the ith visitor converted) and <code>False</code> if not. Finally we take advantage of the fact that the <code>sum</code> of an iterable of booleans is equal to the number of <code>True</code> elements it contains. </p><p>We use a generator comprehension in this function because <code>n_visitors</code> could potentially be very large, and we want to do these calculations lazily and avoid holding the
outcome for each visitor in memory simultaneously. (If Python generators are new to you, I recommend you <a href="https://www.youtube.com/watch?v=EnSu9hHGq5o">watch</a> or <a href="https://nedbatchelder.com/text/iter.html">read</a> Ned Batchelder&#x27;s fantastic PyCon 2013 talk, &quot;How To Loop Like a Native&quot; for an introduction. If you&#x27;re not using generators, you&#x27;re not using the full power of Python. I talk about them much more in the video tutorials.)</p><p>Finally we need <code>prior_sampler</code>. This should be a generator that yields a large (potentially infinite) number of guesses for the conversion fraction of a layout. Suppose we&#x27;ve never used layout A. Logically we know that it must be somewhere between 0 and 100%, but other than that we have no idea. This generator captures that idea:</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function">uniform_prior_sampler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token triple-quoted-string">&#x27;&#x27;&#x27;Yield random numbers in interval (0, 1).&#x27;&#x27;&#x27;</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">        </span><span class="token keyword">yield</span><span class="token plain"> random</span><span class="token punctuation">.</span><span class="token plain">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>Let&#x27;s write a quick <code>take</code> function that will allow us to peek at a few samples from this generator.</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token keyword">import</span><span class="token plain"> itertools</span></span></div><div class="token-line"><span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function">take</span><span class="token punctuation">(</span><span class="token plain">n</span><span class="token punctuation">,</span><span class="token plain"> iterable</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token string">&quot;Return first n items of the iterable as a list.&quot;</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token plain">itertools</span><span class="token punctuation">.</span><span class="token plain">islice</span><span class="token punctuation">(</span><span class="token plain">iterable</span><span class="token punctuation">,</span><span class="token plain"> n</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>We can use this to draw 3 samples from our &quot;uniform&quot; prior sample like this:</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> take</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token plain"> uniform_prior_sampler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span><span class="token punctuation">[</span><span class="token number">0.8943997782145745</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0.9196888444316101</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0.6267420468068673</span><span class="token punctuation">]</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>Now we&#x27;re ready to run <code>posterior_sampler</code> to create an object that will
yield up samples from the posterior distribution for layout A&#x27;s conversion
fraction:</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token plain">posterior_a_sampler </span><span class="token operator">=</span><span class="token plain"> posterior_sampler</span><span class="token punctuation">(</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    data</span><span class="token operator">=</span><span class="token plain">n_conv_a</span><span class="token punctuation">,</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    prior_sampler</span><span class="token operator">=</span><span class="token plain">uniform_prior_sampler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    simulate</span><span class="token operator">=</span><span class="token keyword">lambda</span><span class="token plain"> p</span><span class="token punctuation">:</span><span class="token plain"> simulate_conversion</span><span class="token punctuation">(</span><span class="token plain">p</span><span class="token punctuation">,</span><span class="token plain"> n_visitors_a</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>(The <code>lambda</code> function here bakes in the number of visitors for layout A into the simulate argument. This is &quot;partial eveluation&quot;. We could also have used <code>functools.partial</code> for this.)</p><p>To get a few samples from the posterior, we can use <code>take</code> again:</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> take</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token plain"> posterior_a_sampler</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span><span class="token punctuation">[</span><span class="token number">0.03810094949124154</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0.067278098392767</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0.05786540496383208</span><span class="token punctuation">]</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>These are three guesses for the unknown conversion fraction of layout A. They are all around 4% percent. That&#x27;s consistent with the fact that we had four conversions from 100 visitors. But note they are not exactly 4%. We can build up a picture of their distribution by getting thousands of samples from <code>posterior_sampler</code> and plotting a histogram.</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token plain">a_samples </span><span class="token operator">=</span><span class="token plain"> take</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span><span class="token plain"> posterior_a_sampler</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">abbins </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token operator">/</span><span class="token number">200.0</span><span class="token plain"> </span><span class="token keyword">for</span><span class="token plain"> i </span><span class="token keyword">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token plain">          </span><span class="token comment"># 50 bins between 0 and 0.25</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">hist</span><span class="token punctuation">(</span><span class="token plain">a_samples</span><span class="token punctuation">,</span><span class="token plain"> bins</span><span class="token operator">=</span><span class="token plain">abbins</span><span class="token punctuation">,</span><span class="token plain"> normed</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token plain">  </span><span class="token comment"># normed=True gives a probability density function</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">xlim</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token plain">abbins</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p><div style="position:relative"><img src="/static/images/2017/07/output_20_0.png" alt="png" style="display:block;margin:0;width:100%"/></div></p><h5>This is the posterior distribution for the conversion fraction of layout A. It&#x27;s a full picture of our knowledge after the experiment.</h5><p>The posterior distribution is the object we use to answer concrete questions about our knowledge after an experiment. We can, for example, use this one to say how likely it is that layout A&#x27;s conversion fraction is greater than 10%. We can do this by measuring the fraction of <code>a_samples</code> for which that is true:</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token plain">a </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0.1</span><span class="token plain"> </span><span class="token keyword">for</span><span class="token plain"> a </span><span class="token keyword">in</span><span class="token plain"> a_samples</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token plain">a_samples</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span><span class="token number">0.0202</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>Again, we&#x27;re using the fact that the sum of an iterable of booleans is equal the number of true elements.</p><p>This tells us there&#x27;s a 2% chance layout A&#x27;s conversion fraction is greater than 10% (or equivalently, we can be 98% certain it&#x27;s less than 10%).</p><h2>Completing the A/B test</h2><p>To complete the A/B test, however, we also need the posterior for layout B.</p><p>Let&#x27;s suppose that layout B is not brand new. We do have a rough idea of its conversion fraction before we conduct the experiment. Perhaps we think it&#x27;s 6%, plus or minus a couple of per cent. In this case, uniform_prior_sampler is not appropriate, but something like this would work well:</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function">normal_prior_sampler</span><span class="token punctuation">(</span><span class="token plain">mu</span><span class="token operator">=</span><span class="token number">0.06</span><span class="token punctuation">,</span><span class="token plain"> sigma</span><span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token triple-quoted-string">&#x27;&#x27;&#x27;Yield stream of samples from N(mu, sigma) in interval (0, 1).&#x27;&#x27;&#x27;</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">        x </span><span class="token operator">=</span><span class="token plain"> random</span><span class="token punctuation">.</span><span class="token plain">normalvariate</span><span class="token punctuation">(</span><span class="token plain">mu</span><span class="token punctuation">,</span><span class="token plain"> sigma</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">&lt;=</span><span class="token plain"> x </span><span class="token operator">&lt;=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">:</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">            </span><span class="token keyword">yield</span><span class="token plain"> x</span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>Mathematically, this function samples from a normal distribution with a known mean and standard deviation, and support in the interval (0, 1). Conceptually, though, it&#x27;s easier to plot a histogram, and compare this prior to the uniform prior we used for layout A.</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">hist</span><span class="token punctuation">(</span><span class="token plain">take</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span><span class="token plain"> uniform_prior_sampler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> bins</span><span class="token operator">=</span><span class="token plain">abbins</span><span class="token punctuation">,</span><span class="token plain"> label</span><span class="token operator">=</span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">,</span><span class="token plain"> normed</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">hist</span><span class="token punctuation">(</span><span class="token plain">take</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span><span class="token plain"> normal_prior_sampler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> bins</span><span class="token operator">=</span><span class="token plain">abbins</span><span class="token punctuation">,</span><span class="token plain"> label</span><span class="token operator">=</span><span class="token string">&#x27;B&#x27;</span><span class="token punctuation">,</span><span class="token plain"> alpha</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token plain"> normed</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">title</span><span class="token punctuation">(</span><span class="token string">&#x27;Prior distributions&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">xlim</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token plain">abbins</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">legend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p><div style="position:relative"><img src="/static/images/2017/07/output_26_0.png" alt="png" style="display:block;margin:0;width:100%"/></div></p><h5>The guesses for layout B are concentrated around 6%, which captures our prior knowledge.</h5><p>Now we have the prior sampler for layout B we can make its posterior sampler and take some samples.</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token plain">posterior_b_sampler </span><span class="token operator">=</span><span class="token plain"> posterior_sampler</span><span class="token punctuation">(</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    data</span><span class="token operator">=</span><span class="token plain">n_conv_b</span><span class="token punctuation">,</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    prior_sampler</span><span class="token operator">=</span><span class="token plain">normal_prior_sampler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">    simulate</span><span class="token operator">=</span><span class="token keyword">lambda</span><span class="token plain"> p</span><span class="token punctuation">:</span><span class="token plain"> simulate_conversion</span><span class="token punctuation">(</span><span class="token plain">p</span><span class="token punctuation">,</span><span class="token plain"> n_visitors_b</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">b_samples </span><span class="token operator">=</span><span class="token plain"> take</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span><span class="token plain"> posterior_b_sampler</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>Let&#x27;s visualize the two sets of posterior samples directly.</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">hist</span><span class="token punctuation">(</span><span class="token plain">a_samples</span><span class="token punctuation">,</span><span class="token plain"> bins</span><span class="token operator">=</span><span class="token plain">abbins</span><span class="token punctuation">,</span><span class="token plain"> label</span><span class="token operator">=</span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">,</span><span class="token plain"> normed</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">hist</span><span class="token punctuation">(</span><span class="token plain">b_samples</span><span class="token punctuation">,</span><span class="token plain"> bins</span><span class="token operator">=</span><span class="token plain">abbins</span><span class="token punctuation">,</span><span class="token plain"> label</span><span class="token operator">=</span><span class="token string">&#x27;B&#x27;</span><span class="token punctuation">,</span><span class="token plain"> alpha</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token plain"> normed</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">title</span><span class="token punctuation">(</span><span class="token string">&#x27;Posterior distributions&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">xlim</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token plain">abbins</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain">plt</span><span class="token punctuation">.</span><span class="token plain">legend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p><div style="position:relative"><img src="/static/images/2017/07/output_30_0.png" alt="png" style="display:block;margin:0;width:100%"/></div></p><h5>Note the histogram for layout B is to the right of that for layout A. This is telling us that layout B is probably better than layout A.</h5><p>And we&#x27;re finally in a position to answer the original question: how confident can we be that layout B is better?</p><p>In this simple case, we can do this by making pairwise comparisons between the two lists of estimates and measuring the fraction of pairs for which the estimated conversion fraction of B is bigger than that for A.</p><div><div style="position:relative;margin-bottom:25.784999999999997px;width:602px;margin-left:-20.338749999999997px;margin-right:-20.338749999999997px"><div class="prism-code language-python" style="overflow-x:auto;overflow-y:hidden;background:#f3f3f3"><pre style="float:left;font-size:12.892499999999998px;min-width:100%;position:relative;line-height:1.5;margin:0;padding:12.892499999999998px;overflow:visible"><div class="token-line"><span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token plain">b </span><span class="token operator">&gt;</span><span class="token plain"> a </span><span class="token keyword">for</span><span class="token plain"> a</span><span class="token punctuation">,</span><span class="token plain"> b </span><span class="token keyword">in</span><span class="token plain"> </span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token plain">a_samples</span><span class="token punctuation">,</span><span class="token plain"> b_samples</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token plain">a_samples</span><span class="token punctuation">)</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span><span class="token number">0.659</span><span class="token plain"></span></span></div><div class="token-line"><span><span class="token plain"></span></span></div></pre><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><p>And that&#x27;s it! Given the data and our prior beliefs, we are 66% sure that layout B is better than A.</p><p>If a mistake is going to cost us $1 million, this probably isn&#x27;t confident enough. We need to run a bigger A/B test before making this business decision. If we collect more data, however, we&#x27;ll quickly run into one of the limitations of ABC: it&#x27;s slow. Change the data and rerun this code to see for yourself.</p><p>Approximate Bayesian Computation is slow and in some ways crude. There are often <a href="http://blog.fastforwardlabs.com/2017/01/30/the-algorithms-behind-probabilistic-programming.html">better options</a>. But it&#x27;s not cheating. In the tutorials, I show how to speed it up for more realistic problems.</p><h2>Next steps</h2><p>This article hopefully helped you to form a mental model of the relationship between the prior and the posterior distributions. This should leave you in good shape to look deeper into probabilistic programming and inference. </p><p>Log in to O&#x27;Reilly Safari and check out the three tutorials for a deeper video and text discussion, interactive code examples, exercises, and ideas for where to go next:</p><ul><li><a href="https://www.safaribooksonline.com/oriole/probabilistic-programming-from-scratch-1-a-b-testing-with-approximate-bayesian-computation">Part 1: A/B Testing with Approximate Bayesian Computation</a></li><li><a href="https://www.safaribooksonline.com/oriole/probabilistic-programming-from-scratch-2-bayes-theorem-and-online-learning">Part 2: Bayes&#x27; Theorem and Online Learning</a></li><li><a href="https://www.safaribooksonline.com/oriole/probabilistic-programming-from-scratch-3-improving-algorithmic-performance-and-online-learning">Part 3: Improving Algorithmic Performance and PyMC3</a></li></ul><p>The <a href="http://blog.fastforwardlabs.com/2017/01/18/new-research-on-probabilistic-programming.html">Fast Forward Labs report</a>, meanwhile, discusses the business case for probabilistic programming in detail, and compares modern industrial strength systems like Stan and PyMC3. Please <a href="http://www.fastforwardlabs.com/#contact">get in touch</a> if you&#x27;re interested in working with us.</p><div style="display:none;justify-content:center;padding:12.892499999999998px" class="jsx-1135431938 jsx-2959859206"><img style="height:18.75272727272727px;width:18.75272727272727px;position:relative;display:block" src="/static/images/ff.png" class="jsx-1135431938 jsx-2959859206"/></div></div></div></div><div style="position:relative;display:block;width:612.8924999999999px;grid-template-columns:repeat(2, 1fr);margin-left:-12.892499999999998px;margin-right:-12.892499999999998px"><div style="display:grid"><div style="position:relative;display:grid;grid-template-rows:auto 1fr;margin-bottom:12.892499999999998px"><div style="text-transform:uppercase;font-size:12.892499999999998px;letter-spacing:0.03em;line-height:1.5;padding-bottom:6.446249999999999px;padding-left:25.784999999999997px">Newer</div><div style="position:relative;display:grid"><a class="hover-box no-underline no-hover gray-backer hover-extend" style="display:block;position:relative;width:612.8925px;padding-left:12.892499999999998px;padding-right:12.892499999999998px;margin-left:0;margin-right:0" href="/2017/07/25/why-we-talk-about-AI-the-way-we-do.html"><div style="display:flex;flex-wrap:wrap"><div style="display:flex;width:587.1075px;font-size:12.892499999999998px;letter-spacing:0.03em;text-transform:uppercase;line-height:1.5;margin-left:0"><div style="width:293.55375px;padding:12.892499999999998px 12.892499999999998px 0px 12.892499999999998px"><div>Aug 04 2017</div></div><div style="width:293.55375px;padding:12.892499999999998px 12.892499999999998px 0px 12.892499999999998px"><div>post</div></div></div><div style="position:relative;width:587.1075px;padding:12.892499999999998px 0px"><div style="font-size:34.379999999999995px;line-height:1.25;padding:0px 12.892499999999998px;margin-top:-6.446249999999999px"><div style="padding-left:0">Why we talk about AI the way we do, and why we have to change it.</div></div><div style="padding-top:6.446249999999999px;position:relative"><div style="font-size:15.041249999999998px;line-height:1.5em;display:flex;flex-wrap:wrap;padding-left:0"><div style="padding:0px 12.892499999999998px;width:293.55375px"><div style="height:90.24749999999999px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:4;hyphens:auto;-webkit-box-orient:vertical"><span>by <!-- -->Friederike<!-- --> â—¦ </span>
The public conversation about machine learning and AI happens at the extremes. AI is either awesome or scary. It writes movie scripts, wins at poker and Go, and helps Google cool its data centers. Awesome! It will take our jobs and robot investors will incite wars for profits...</div><div style="overflow:hidden;width:100%;text-overflow:ellipsis;white-space:nowrap"><span class="display-link"><span>View<!-- --> <span style="text-transform:lowercase">post</span></span></span></div></div><div style="position:relative;width:293.55375px"><div style="width:calc(100% - 25.784999999999997px);height:calc(100% - 12.892499999999998px);margin-left:12.892499999999998px;margin-top:6.446249999999999px;background-image:url(/staticTBA);background-size:contain;background-position:center center;background-repeat:no-repeat"></div></div></div></div></div></div></a><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div><div style="display:grid"><div style="position:relative;display:grid;grid-template-rows:auto 1fr;margin-bottom:12.892499999999998px"><div style="text-transform:uppercase;font-size:12.892499999999998px;letter-spacing:0.03em;line-height:1.5;padding-bottom:6.446249999999999px;padding-left:25.784999999999997px">Older</div><div style="position:relative;display:grid"><a class="hover-box no-underline no-hover gray-backer hover-extend" style="display:block;position:relative;width:612.8925px;padding-left:12.892499999999998px;padding-right:12.892499999999998px;margin-left:0;margin-right:0" href="/2017/06/25/fingerprinting-documents-with-steganography.html"><div style="display:flex;flex-wrap:wrap"><div style="display:flex;width:587.1075px;font-size:12.892499999999998px;letter-spacing:0.03em;text-transform:uppercase;line-height:1.5;margin-left:0"><div style="width:293.55375px;padding:12.892499999999998px 12.892499999999998px 0px 12.892499999999998px"><div>Jun 06 2017</div></div><div style="width:293.55375px;padding:12.892499999999998px 12.892499999999998px 0px 12.892499999999998px"><div>post</div></div></div><div style="position:relative;width:587.1075px;padding:12.892499999999998px 0px"><div style="font-size:25.784999999999997px;line-height:1.25;padding:0px 12.892499999999998px;margin-top:-6.446249999999999px"><div style="padding-left:0">Fâ ingerprinting documentsâ€‹ with steganographyâ€‹</div></div><div style="padding-top:6.446249999999999px;position:relative"><div style="font-size:15.041249999999998px;line-height:1.5em;display:flex;flex-wrap:wrap;padding-left:0"><div style="padding:0px 12.892499999999998px;width:293.55375px"><div style="height:90.24749999999999px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:4;hyphens:auto;-webkit-box-orient:vertical"><span>by <!-- -->Noam<!-- --> â—¦ </span>
Steganography is theâ€‹ practiceâ€‹ ofâ€‹ hiding messagesâ€‹ anywhereâ€‹ theyâ€™reâ€‹ not expectedâ€â€Ž.
Iâ n a well-executedâ€‹ piece ofâ€‹ steganography, anyone whoâ€‹ isâ€‹ not the intendedâ€‹
recipient canâ€‹ look atâ€‹ theâ€‹ messageâ€‹ and notâ€‹ realize its there at allâ€â€Ž. In a recent
headline-making
story...</div><div style="overflow:hidden;width:100%;text-overflow:ellipsis;white-space:nowrap"><span class="display-link"><span>View<!-- --> <span style="text-transform:lowercase">post</span></span></span></div></div><div style="position:relative;width:293.55375px"><div style="width:calc(100% - 25.784999999999997px);height:calc(100% - 12.892499999999998px);margin-left:12.892499999999998px;margin-top:6.446249999999999px;background-image:url(/static/images/2017/06/confusables.png);background-size:contain;background-position:center center;background-repeat:no-repeat"></div></div></div></div></div></div></a><div style="position:absolute;left:-1px;top:-1px;height:calc(158.7301587301587% + 2px);width:calc(158.7301587301587% + 2px);transform:scale(0.6300000000000001);transform-origin:left top;border:solid 2px black;pointer-events:none"></div></div></div></div></div><div style="padding-bottom:25.784999999999997px;padding-top:25.784999999999997px" class="jsx-1135431938 jsx-2959859206"><div style="font-size:34.379999999999995px;line-height:1.25;padding:0px 12.892499999999998px 0px 12.892499999999998px;margin-bottom:12.892499999999998px;width:587.1075px;margin-left:0" class="jsx-1135431938 jsx-2959859206">About</div><div style="padding:0px 12.892499999999998px;margin-bottom:12.892499999999998px;width:587.1075px;margin-left:0;font-size:17.189999999999998px;line-height:1.5" class="jsx-1135431938 jsx-2959859206">Cloudera Fast Forward Labs is an applied machine learning research group. We help organizations recognize and develop new product and business opportunities through emerging technologies.<!-- --> </div><div style="padding:0px 12.892499999999998px;margin-bottom:12.892499999999998px;width:587.1075px;margin-left:0;font-size:17.189999999999998px;line-height:1.5" class="jsx-1135431938 jsx-2959859206"><a href="https://www.cloudera.com/products/fast-forward-labs-research.html" class="jsx-1135431938 jsx-2959859206">Learn more about working with us.</a></div></div></div><div class="jsx-1135431938 jsx-2959859206"><div style="position:relative" class="jsx-1135431938 jsx-2959859206"><div style="position:absolute;left:0;width:100%;height:2px;transform:scaleY(0.60165);transform-origin:center center;background:black;top:-1px"></div><div style="padding:12.892499999999998px;display:flex;justify-content:space-between;flex-wrap:wrap;font-size:17.189999999999998px;line-height:1.5" class="jsx-1135431938 jsx-2959859206"><div class="jsx-1135431938 jsx-2959859206"><a href="/" class="jsx-1135431938 jsx-2959859206">Blog</a></div><div style="display:flex;flex-wrap:wrap" class="jsx-1135431938 jsx-2959859206"><div style="margin-right:12.892499999999998px" class="jsx-1135431938 jsx-2959859206"><a href="https://www.cloudera.com/products/fast-forward-labs-research.html" class="jsx-1135431938 jsx-2959859206">Cloudera</a></div><div style="margin-right:12.892499999999998px" class="jsx-1135431938 jsx-2959859206"><a href="https://blog.fastforwardlabs.com/" class="jsx-1135431938 jsx-2959859206">AI Experiments</a></div><div class="jsx-1135431938 jsx-2959859206"><a href="https://twitter.com/fastforwardlabs" class="jsx-1135431938 jsx-2959859206">Twitter</a></div></div></div></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/posts/2017-07-05-probabilistic-programming-from-scratch","query":{},"buildId":"Ybc3fb3eGTaHFGC_lgzB6","nextExport":true}</script><script async="" id="__NEXT_PAGE__/posts/2017-07-05-probabilistic-programming-from-scratch" src="/_next/static/Ybc3fb3eGTaHFGC_lgzB6/pages/posts/2017-07-05-probabilistic-programming-from-scratch.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/Ybc3fb3eGTaHFGC_lgzB6/pages/_app.js"></script><script src="/_next/static/runtime/webpack-fdce77a122c11e06ae50.js" async=""></script><script src="/_next/static/chunks/commons.f77b50de979bfbbb280b.js" async=""></script><script src="/_next/static/runtime/main-5ab107747766f1b4e0bf.js" async=""></script></body></html>